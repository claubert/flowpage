<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Selecionar Plano • Flowhedge</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:Inter,system-ui,Arial,sans-serif;margin:0;padding:0;background:#0b1220;color:#f4f7ff}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px 24px;background:#0e1628;border-bottom:1px solid #18233a}
    nav a{color:#cfe2ff;text-decoration:none;margin-left:16px}
    main{max-width:900px;margin:24px auto;padding:0 24px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-bottom:16px}
    .card{background:#111a2e;border:1px solid #1d2a49;padding:16px;border-radius:10px}
    .plan{display:flex;flex-direction:column;gap:8px}
    .plan h3{margin:0}
    .plan .price{font-size:28px;color:#93c5fd}
    label{font-size:12px;color:#a9b4d9;margin-bottom:6px;display:block}
    input,button{width:100%;padding:10px;border-radius:8px;border:1px solid #1d2a49;background:#0e1628;color:#e6edff}
    button{cursor:pointer;transition:transform .1s ease,opacity .2s ease}
    button:hover{transform:translateY(-1px)}
    button:active{transform:translateY(1px)}
    button.primary{background:#22c55e;border:none}
    .loading{display:none;align-items:center;gap:8px;margin-top:8px}
    .spinner{width:18px;height:18px;border:2px solid #93c5fd;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header>
    <div>Flowhedge</div>
    <nav>
      <a href="/">Home</a>
      <a href="/planos.html">Planos</a>
      <a href="/login.html">Login</a>
    </nav>
  </header>
  <main>
    <h2>Selecione um Plano</h2>
    <div class="grid">
      <div class="card plan" aria-label="Plano Mensal">
        <h3>Mensal</h3>
        <div class="price">R$ 0,01 / mês</div>
        <ul>
          <li>Acesso completo</li>
          <li>Renovação mensal</li>
        </ul>
        <button class="primary" onclick="abrirContratacao('mensal')" aria-label="Contratar plano mensal">Contratar</button>
      </div>
      <div class="card plan" aria-label="Plano Semestral">
        <h3>Semestral</h3>
        <div class="price">R$ 0,00 / mês</div>
        <button onclick="abrirContratacao('semestral')" aria-label="Contratar plano semestral">Contratar</button>
      </div>
      <div class="card plan" aria-label="Plano Anual">
        <h3>Anual</h3>
        <div class="price">R$ 0,00 / mês</div>
        <button onclick="abrirContratacao('anual')" aria-label="Contratar plano anual">Contratar</button>
      </div>
    </div>

    <div class="card" id="form" style="display:none">
      <h3>Dados para Contratação</h3>
      <label>Nome</label>
      <input id="nome" />
      <label>E-mail</label>
      <input id="email" type="email" />
      <button class="primary" id="btnContratar" onclick="contratar()" aria-label="Confirmar contratação">Prosseguir para PIX</button>
      <div class="loading" id="loading" role="status" aria-live="polite"><div class="spinner"></div><span>Processando...</span></div>
      <p id="msg"></p>
    </div>
  </main>
  <script>
    let planoSelecionado='mensal';
    function abrirContratacao(cod){planoSelecionado=cod;document.getElementById('form').style.display='block';}
    async function contratar(){
      const nome=document.getElementById('nome').value.trim();
      const email=document.getElementById('email').value.trim();
      const msg=document.getElementById('msg');
      const btn=document.getElementById('btnContratar');
      const loading=document.getElementById('loading');
      if(!nome||!email){msg.textContent='Preencha nome e e-mail';return}
      btn.setAttribute('aria-busy','true');btn.disabled=true;loading.style.display='flex';msg.textContent='';
      const controller=new AbortController();const t=setTimeout(()=>controller.abort(),20000);
      try{
        const r=await fetch('/contratar',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({plano_codigo:planoSelecionado,email,nome}),signal:controller.signal});
        const j=await r.json();
        if(r.ok && j.id_externo){localStorage.setItem('assinatura_id',String(j.assinatura_id));localStorage.setItem('pix_id_externo',j.id_externo);localStorage.setItem('email_contratante',email);location.href='/pix.html?id_externo='+j.id_externo;} else {msg.textContent=j.erro||'Falha na contratação'}
      }catch(e){msg.textContent='Erro de conexão'}
      clearTimeout(t);btn.removeAttribute('aria-busy');btn.disabled=false;loading.style.display='none';
    }
  </script>
</body>
</html>